<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ObRail Europe – Analytics</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0
        }

        :root {
            --bg: #0d0f14;
            --surface: #13161f;
            --surface2: #1b1f2e;
            --surface3: #222638;
            --border: #252a3d;
            --accent: #4f7ef7;
            --green: #34c98a;
            --amber: #e8a838;
            --red: #e05252;
            --purple: #9b7cf4;
            --text: #dde3f0;
            --muted: #59627a;
            --muted2: #8892a8;
            --sidebar: 230px;
            --header: 52px;
            --r: 8px;
        }

        html {
            font-size: 14px
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased
        }

        /* ── Scrollbar ─────────────────────────────────────────────────── */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px
        }

        ::-webkit-scrollbar-track {
            background: transparent
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px
        }

        /* ── Header ────────────────────────────────────────────────────── */
        header {
            height: var(--header);
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 200;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px
        }

        .logo-mark {
            width: 26px;
            height: 26px;
            border-radius: 6px;
            background: linear-gradient(135deg, var(--accent), var(--purple));
            flex-shrink: 0;
        }

        .logo-text {
            font-size: 13px;
            font-weight: 700;
            letter-spacing: .02em;
            color: var(--text)
        }

        .logo-sub {
            font-size: 11px;
            font-weight: 400;
            color: var(--muted);
            margin-left: 8px
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 6px
        }

        .header-pill {
            font-size: 11px;
            color: var(--muted2);
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 3px 10px;
        }

        /* ── Layout ────────────────────────────────────────────────────── */
        .shell {
            display: flex;
            margin-top: var(--header);
            min-height: calc(100vh - var(--header))
        }

        /* ── Sidebar ───────────────────────────────────────────────────── */
        aside {
            width: var(--sidebar);
            background: var(--surface);
            border-right: 1px solid var(--border);
            padding: 16px 0;
            position: fixed;
            top: var(--header);
            bottom: 0;
            overflow-y: auto;
        }

        .nav-group-label {
            padding: 10px 16px 4px;
            font-size: 10px;
            font-weight: 600;
            letter-spacing: .08em;
            text-transform: uppercase;
            color: var(--muted);
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 9px;
            padding: 8px 16px;
            cursor: pointer;
            color: var(--muted2);
            font-size: 12.5px;
            font-weight: 500;
            border-left: 2px solid transparent;
            transition: background .12s, color .12s, border-color .12s;
            user-select: none;
        }

        .nav-item:hover {
            background: var(--surface2);
            color: var(--text)
        }

        .nav-item.active {
            background: var(--surface2);
            color: var(--accent);
            border-left-color: var(--accent);
        }

        .nav-icon {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
            opacity: .7;
        }

        .nav-item.active .nav-icon {
            opacity: 1
        }

        .nav-sep {
            height: 1px;
            background: var(--border);
            margin: 8px 0
        }

        /* ── Main ──────────────────────────────────────────────────────── */
        main {
            margin-left: var(--sidebar);
            flex: 1;
            padding: 24px;
            min-width: 0;
            max-width: 100%
        }

        /* ── Page header ───────────────────────────────────────────────── */
        .pg-header {
            margin-bottom: 20px
        }

        .pg-crumb {
            font-size: 11px;
            color: var(--muted);
            margin-bottom: 5px
        }

        .pg-crumb span {
            color: var(--muted2)
        }

        .pg-title {
            font-size: 18px;
            font-weight: 700;
            letter-spacing: -.01em;
            margin-bottom: 3px
        }

        .pg-sub {
            font-size: 12px;
            color: var(--muted2)
        }

        /* ── KPI cards ─────────────────────────────────────────────────── */
        .kpi-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
            gap: 12px;
            margin-bottom: 20px
        }

        .kpi-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--r);
            padding: 16px 18px;
            transition: border-color .15s;
        }

        .kpi-card:hover {
            border-color: var(--surface3)
        }

        .kpi-lbl {
            font-size: 10.5px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: .07em;
            color: var(--muted);
            margin-bottom: 8px
        }

        .kpi-val {
            font-size: 24px;
            font-weight: 700;
            line-height: 1;
            letter-spacing: -.02em
        }

        .kpi-meta {
            font-size: 11px;
            color: var(--muted2);
            margin-top: 6px
        }

        .kpi-good {
            color: var(--green)
        }

        .kpi-warn {
            color: var(--amber)
        }

        /* ── Card / section ────────────────────────────────────────────── */
        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--r);
            margin-bottom: 16px;
            overflow: hidden;
        }

        .card-head {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            flex-wrap: wrap;
        }

        .card-title {
            font-size: 12.5px;
            font-weight: 600;
            color: var(--text)
        }

        .card-body {
            padding: 16px
        }

        .card-body-flush {
            padding: 0
        }

        /* ── Controls ──────────────────────────────────────────────────── */
        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: flex-end
        }

        .ctrl {
            display: flex;
            flex-direction: column;
            gap: 4px
        }

        .ctrl-lbl {
            font-size: 10.5px;
            font-weight: 600;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: .05em
        }

        select,
        input[type=text],
        input[type=number] {
            background: var(--surface2);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 7px 10px;
            border-radius: 6px;
            font-size: 12.5px;
            font-family: 'Inter', sans-serif;
            outline: none;
            transition: border-color .12s;
        }

        select {
            cursor: pointer;
            padding-right: 26px;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6' viewBox='0 0 10 6'%3E%3Cpath fill='%2359627a' d='M5 6 0 0h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 9px center;
        }

        select:focus,
        input:focus {
            border-color: var(--accent)
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 7px 14px;
            border: 0;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12.5px;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            transition: opacity .12s;
            white-space: nowrap;
        }

        .btn:hover {
            opacity: .82
        }

        .btn-primary {
            background: var(--accent);
            color: #fff
        }

        .btn-ghost {
            background: var(--surface2);
            color: var(--muted2);
            border: 1px solid var(--border)
        }

        .btn-ghost:hover {
            color: var(--text)
        }

        /* ── Selector bar ──────────────────────────────────────────────── */
        .selector-bar {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--r);
            padding: 12px 16px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 14px;
            flex-wrap: wrap;
        }

        .selector-bar .ctrl-lbl {
            color: var(--muted);
            margin-bottom: 0
        }

        /* ── Table ─────────────────────────────────────────────────────── */
        .tbl-wrap {
            overflow-x: auto
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px
        }

        thead tr {
            background: var(--surface2)
        }

        th {
            padding: 9px 11px;
            text-align: left;
            font-weight: 600;
            font-size: 10.5px;
            text-transform: uppercase;
            letter-spacing: .06em;
            color: var(--muted);
            white-space: nowrap;
            border-bottom: 1px solid var(--border);
        }

        td {
            padding: 9px 11px;
            border-bottom: 1px solid var(--border);
            color: var(--muted2);
            vertical-align: middle
        }

        tbody tr:last-child td {
            border-bottom: 0
        }

        tbody tr:hover td {
            background: var(--surface2);
            color: var(--text)
        }

        /* ── Badge / tag ───────────────────────────────────────────────── */
        .badge {
            display: inline-block;
            padding: 2px 7px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
            letter-spacing: .04em;
            text-transform: uppercase;
        }

        .badge-green {
            background: #0a2e1e;
            color: #34c98a
        }

        .badge-blue {
            background: #0d1e3d;
            color: #7eb3ff
        }

        .badge-amber {
            background: #2e1f06;
            color: #e8a838
        }

        .badge-red {
            background: #2e0a0a;
            color: #e05252
        }

        .badge-purple {
            background: #1c1040;
            color: #b59cf7
        }

        /* ── Bar chart ─────────────────────────────────────────────────── */
        .bars {
            display: flex;
            flex-direction: column;
            gap: 9px
        }

        .bar-row {
            display: grid;
            grid-template-columns: 150px 1fr 80px;
            align-items: center;
            gap: 10px
        }

        .bar-lbl {
            font-size: 12px;
            color: var(--muted2);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis
        }

        .bar-bg {
            background: var(--surface2);
            border-radius: 3px;
            height: 16px;
            overflow: hidden
        }

        .bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width .45s ease
        }

        .bar-val {
            font-size: 12px;
            font-weight: 600;
            color: var(--text);
            text-align: right
        }

        /* ── Metric pair ───────────────────────────────────────────────── */
        .metric-pair {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px
        }

        @media(max-width:560px) {
            .metric-pair {
                grid-template-columns: 1fr
            }
        }

        .metric-box {
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: var(--r);
            padding: 14px 16px;
        }

        .metric-lbl {
            font-size: 10.5px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: .07em;
            color: var(--muted);
            margin-bottom: 6px
        }

        .metric-val {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -.01em
        }

        .metric-sub {
            font-size: 11px;
            color: var(--muted2);
            margin-top: 5px
        }

        /* ── Saving box ────────────────────────────────────────────────── */
        .saving-box {
            background: #071e12;
            border: 1px solid #1a4d30;
            border-radius: var(--r);
            padding: 12px 16px;
            margin-top: 12px;
            font-size: 12.5px;
            color: var(--muted2);
        }

        .saving-box strong {
            color: var(--green);
            font-size: 16px
        }

        /* ── Map ───────────────────────────────────────────────────────── */
        #map {
            height: 400px;
            border-radius: 0
        }

        /* ── States ────────────────────────────────────────────────────── */
        .state {
            text-align: center;
            padding: 36px 16px;
            font-size: 12.5px;
            color: var(--muted)
        }

        .state-icon {
            font-size: 24px;
            margin-bottom: 8px;
            opacity: .4
        }

        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin .65s linear infinite;
            vertical-align: middle;
            margin-right: 6px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg)
            }
        }

        /* ── Source note ───────────────────────────────────────────────── */
        .source-note {
            font-size: 10.5px;
            color: var(--muted);
            margin-top: 12px;
            line-height: 1.6
        }

        /* ── Stops panel ───────────────────────────────────────────────── */
        .stop-row {
            padding: 7px 0;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: baseline;
            gap: 10px;
            font-size: 12px;
        }

        .stop-row:last-child {
            border: 0
        }

        .stop-seq {
            color: var(--accent);
            font-weight: 600;
            min-width: 22px;
            font-size: 11px
        }

        .stop-name {
            font-weight: 500;
            color: var(--text)
        }

        .stop-meta {
            color: var(--muted);
            font-size: 11px
        }
    </style>
</head>

<body>

    <!-- HEADER -->
    <header>
        <div class="logo">
            <div class="logo-mark"></div>
            <span class="logo-text">ObRail Europe</span>
            <span class="logo-sub">Railway Analytics Platform</span>
        </div>
        <div class="header-right">
            <span class="header-pill">v2.0</span>
        </div>
    </header>

    <div class="shell">

        <!-- SIDEBAR -->
        <aside>
            <div class="nav-group-label">Platform</div>

            <div class="nav-item active" onclick="nav('overview',this)">
                <svg class="nav-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
                    <rect x="1" y="1" width="6" height="6" rx="1.5" />
                    <rect x="9" y="1" width="6" height="6" rx="1.5" />
                    <rect x="1" y="9" width="6" height="6" rx="1.5" />
                    <rect x="9" y="9" width="6" height="6" rx="1.5" />
                </svg>
                Overview
            </div>

            <div class="nav-item" onclick="nav('explorer',this)">
                <svg class="nav-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
                    <circle cx="7" cy="7" r="5" />
                    <line x1="11" y1="11" x2="15" y2="15" />
                </svg>
                Trip Explorer
            </div>

            <div class="nav-sep"></div>
            <div class="nav-group-label">Analytics</div>

            <div class="nav-item" onclick="nav('environmental',this)">
                <svg class="nav-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M8 14s-6-3.5-6-8a6 6 0 0 1 12 0c0 4.5-6 8-6 8z" />
                </svg>
                Environmental
            </div>

            <div class="nav-item" onclick="nav('demand',this)">
                <svg class="nav-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
                    <polyline points="1,12 5,7 9,9 15,3" />
                </svg>
                Demand &amp; Business
            </div>

            <div class="nav-item" onclick="nav('coverage',this)">
                <svg class="nav-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
                    <circle cx="8" cy="8" r="6" />
                    <path d="M2 8h12M8 2a10 10 0 0 1 0 12M8 2a10 10 0 0 0 0 12" />
                </svg>
                Coverage
            </div>

            <div class="nav-sep"></div>
            <div class="nav-group-label">Reference</div>

            <div class="nav-item" onclick="nav('operators',this)">
                <svg class="nav-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
                    <rect x="1" y="4" width="14" height="9" rx="1.5" />
                    <path d="M5 4V3a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v1" />
                </svg>
                Operators
            </div>
        </aside>

        <!-- MAIN -->
        <main>

            <!-- OVERVIEW -->
            <div id="pg-overview" class="page">
                <div class="pg-header">
                    <div class="pg-crumb">Platform <span>/ Overview</span></div>
                    <div class="pg-title">Overview</div>
                    <div class="pg-sub">Summary of the ObRail Europe data mart</div>
                </div>
                <div class="kpi-row" id="overviewKpis">
                    <div class="state"><span class="spinner"></span>Loading</div>
                </div>
                <div class="card">
                    <div class="card-head">
                        <div class="card-title">Trips by Country</div>
                        <select id="coverageSort" onchange="renderCoverageChart()" style="width:auto">
                            <option value="trips">By volume</option>
                            <option value="alpha">Alphabetical</option>
                        </select>
                    </div>
                    <div class="card-body">
                        <div class="bars" id="coverageChart">
                            <div class="state"><span class="spinner"></span>Loading</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TRIP EXPLORER -->
            <div id="pg-explorer" class="page" style="display:none">
                <div class="pg-header">
                    <div class="pg-crumb">Platform <span>/ Trip Explorer</span></div>
                    <div class="pg-title">Trip Explorer</div>
                    <div class="pg-sub">Filter and inspect individual rail segments across Europe</div>
                </div>

                <div class="card">
                    <div class="card-head">
                        <div class="card-title">Filters</div>
                    </div>
                    <div class="card-body">
                        <div class="controls">
                            <div class="ctrl">
                                <div class="ctrl-lbl">Country</div>
                                <select id="expCountry">
                                    <option value="">All</option>
                                </select>
                            </div>
                            <div class="ctrl">
                                <div class="ctrl-lbl">Operator ID</div>
                                <input type="text" id="expOperator" placeholder="sncf_voyageurs" style="width:148px" />
                            </div>
                            <div class="ctrl">
                                <div class="ctrl-lbl">Departure</div>
                                <input type="text" id="expDep" placeholder="Paris" style="width:120px" />
                            </div>
                            <div class="ctrl">
                                <div class="ctrl-lbl">Arrival</div>
                                <input type="text" id="expArr" placeholder="Lyon" style="width:120px" />
                            </div>
                            <div class="ctrl">
                                <div class="ctrl-lbl">Type</div>
                                <select id="expNight">
                                    <option value="">All</option>
                                    <option value="false">Day</option>
                                    <option value="true">Night</option>
                                </select>
                            </div>
                            <div class="ctrl">
                                <div class="ctrl-lbl">CO2 view</div>
                                <select id="expCo2Mode">
                                    <option value="none">Off</option>
                                    <option value="column" selected>In table</option>
                                </select>
                            </div>
                            <div class="ctrl">
                                <div class="ctrl-lbl">Cabin class</div>
                                <select id="expCabin">
                                    <option value="economy">Economy</option>
                                    <option value="business">Business</option>
                                    <option value="first">First</option>
                                </select>
                            </div>
                            <div class="ctrl">
                                <div class="ctrl-lbl">Limit</div>
                                <input type="number" id="expLimit" value="50" style="width:72px" />
                            </div>
                            <div class="ctrl" style="justify-content:flex-end">
                                <button class="btn btn-primary" onclick="loadTrips()">Search</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-head">
                        <div class="card-title" id="tripCount">Results</div>
                    </div>
                    <div class="card-body-flush tbl-wrap" id="tripTable">
                        <div class="state">Run a search to display trips.</div>
                    </div>
                </div>

                <div class="card" id="stopsCard" style="display:none">
                    <div class="card-head">
                        <div class="card-title">Intermediate Stops</div>
                        <button class="btn btn-ghost"
                            onclick="document.getElementById('stopsCard').style.display='none'">Close</button>
                    </div>
                    <div class="card-body" id="stopsList"></div>
                </div>

                <div class="card">
                    <div class="card-head">
                        <div class="card-title">Route Map</div>
                    </div>
                    <div id="map"></div>
                </div>
            </div>

            <!-- ENVIRONMENTAL -->
            <div id="pg-environmental" class="page" style="display:none">
                <div class="pg-header">
                    <div class="pg-crumb">Analytics <span>/ Environmental</span></div>
                    <div class="pg-title">Environmental KPIs</div>
                    <div class="pg-sub">CO2 analysis across routes, operators and service types</div>
                </div>

                <div class="selector-bar">
                    <div class="ctrl">
                        <div class="ctrl-lbl">KPI Category</div>
                        <select id="envKpiSelect" onchange="loadEnvKpi()">
                            <option value="co2_route">Average CO2 per route</option>
                            <option value="co2_km">CO2 per km by operator</option>
                            <option value="day_night">Day vs Night comparison</option>
                        </select>
                    </div>
                    <div class="ctrl">
                        <div class="ctrl-lbl">Cabin class</div>
                        <select id="envCabin" onchange="loadEnvKpi()">
                            <option value="economy">Economy</option>
                            <option value="business">Business</option>
                            <option value="first">First</option>
                        </select>
                    </div>
                    <div class="ctrl">
                        <div class="ctrl-lbl">Sample limit</div>
                        <input type="number" id="envLimit" value="20" style="width:70px" onchange="loadEnvKpi()" />
                    </div>
                </div>

                <div class="card">
                    <div class="card-head">
                        <div class="card-title" id="envKpiTitle">Average CO2 per route</div>
                    </div>
                    <div class="card-body" id="envKpiBody">
                        <div class="state"><span class="spinner"></span>Loading</div>
                    </div>
                </div>
            </div>

            <!-- DEMAND & BUSINESS -->
            <div id="pg-demand" class="page" style="display:none">
                <div class="pg-header">
                    <div class="pg-crumb">Analytics <span>/ Demand &amp; Business</span></div>
                    <div class="pg-title">Demand &amp; Business KPIs</div>
                    <div class="pg-sub">Operator market share, cross-border traffic and night train distribution</div>
                </div>

                <div class="selector-bar">
                    <div class="ctrl">
                        <div class="ctrl-lbl">KPI Category</div>
                        <select id="demandKpiSelect" onchange="loadDemandKpi()">
                            <option value="operator_share">Operator market share</option>
                            <option value="cross_border">Cross-border vs domestic</option>
                            <option value="night_share">Night train share by country</option>
                        </select>
                    </div>
                </div>

                <div class="card">
                    <div class="card-head">
                        <div class="card-title" id="demandTitle">Operator market share</div>
                    </div>
                    <div class="card-body" id="demandBody">
                        <div class="state"><span class="spinner"></span>Loading</div>
                    </div>
                </div>
            </div>

            <!-- COVERAGE -->
            <div id="pg-coverage" class="page" style="display:none">
                <div class="pg-header">
                    <div class="pg-crumb">Analytics <span>/ Coverage</span></div>
                    <div class="pg-title">Network Coverage</div>
                    <div class="pg-sub">EU, EFTA and candidate member states</div>
                </div>
                <div class="card">
                    <div class="card-head">
                        <div class="card-title">Trips per Country</div>
                    </div>
                    <div class="card-body-flush tbl-wrap" id="coverageFullBody">
                        <div class="state"><span class="spinner"></span>Loading</div>
                    </div>
                </div>
            </div>

            <!-- OPERATORS -->
            <div id="pg-operators" class="page" style="display:none">
                <div class="pg-header">
                    <div class="pg-crumb">Reference <span>/ Operators</span></div>
                    <div class="pg-title">Operators Registry</div>
                    <div class="pg-sub">All rail operators registered in the data mart</div>
                </div>
                <div class="card">
                    <div class="card-head">
                        <div class="card-title">Operators</div>
                    </div>
                    <div class="card-body-flush tbl-wrap" id="operatorsTable">
                        <div class="state"><span class="spinner"></span>Loading</div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        // ================================================================
        //  CONFIG
        // ================================================================
        const CO2_PLANE = { economy: 89, business: 198, first: 290 };
        const CO2_TRAIN = 35;
        const DETOUR = 1.15;
        const PALETTE = ['#4f7ef7', '#34c98a', '#e8a838', '#9b7cf4', '#e05252', '#38c4e8', '#f97b4f'];

        // ================================================================
        //  UTILS
        // ================================================================
        const $ = id => document.getElementById(id);
        const gv = id => $(id).value.trim();

        function haversine(la1, lo1, la2, lo2) {
            const R = 6371, r = x => x * Math.PI / 180, dLa = r(la2 - la1), dLo = r(lo2 - lo1);
            const a = Math.sin(dLa / 2) ** 2 + Math.cos(r(la1)) * Math.cos(r(la2)) * Math.sin(dLo / 2) ** 2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }

        function fmt(n) { return n == null ? '–' : Number(n).toLocaleString('en'); }

        function badge(text, cls) {
            return `<span class="badge badge-${cls}">${text}</span>`;
        }

        function loading(id) {
            $(id).innerHTML = `<div class="state"><span class="spinner"></span>Loading</div>`;
        }

        async function api(url) {
            const r = await fetch(url);
            if (!r.ok) throw new Error(`HTTP ${r.status}`);
            return r.json();
        }

        // ================================================================
        //  NAVIGATION
        // ================================================================
        function nav(page, el) {
            document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            $(`pg-${page}`).style.display = 'block';
            el.classList.add('active');
            if (page === 'overview') loadOverview();
            if (page === 'explorer') initMapOnce();
            if (page === 'environmental') loadEnvKpi();
            if (page === 'demand') loadDemandKpi();
            if (page === 'coverage') loadCoverageFull();
            if (page === 'operators') loadOperators();
        }

        // ================================================================
        //  OVERVIEW
        // ================================================================
        let _coverageData = [];

        async function loadOverview() {
            if ($('overviewKpis').dataset.loaded) return;
            try {
                const [stats, cov] = await Promise.all([api('/stats/coverage'), api('/coverage')]);
                _coverageData = cov;

                const np = stats.night_ratio ? (stats.night_ratio * 100).toFixed(1) : '–';
                const cp = stats.total_trips
                    ? ((stats.cross_border_trips / stats.total_trips) * 100).toFixed(1) : '–';

                $('overviewKpis').innerHTML = `
      <div class="kpi-card">
        <div class="kpi-lbl">Total Trips</div>
        <div class="kpi-val" style="color:var(--accent)">${fmt(stats.total_trips)}</div>
        <div class="kpi-meta">Rail segments indexed</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-lbl">Night Trains</div>
        <div class="kpi-val" style="color:var(--purple)">${fmt(stats.night_trips)}</div>
        <div class="kpi-meta kpi-good">${np}% of total</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-lbl">Cross-border</div>
        <div class="kpi-val" style="color:var(--amber)">${fmt(stats.cross_border_trips)}</div>
        <div class="kpi-meta kpi-warn">${cp}% of total</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-lbl">Countries</div>
        <div class="kpi-val" style="color:var(--green)">${cov.length}</div>
        <div class="kpi-meta">EU / EFTA / Candidate</div>
      </div>`;

                $('overviewKpis').dataset.loaded = '1';
                renderCoverageChart();
            } catch (e) {
                $('overviewKpis').innerHTML = `<div class="state">Failed to load: ${e.message}</div>`;
            }
        }

        function renderCoverageChart() {
            if (!_coverageData.length) return;
            const sort = gv('coverageSort');
            const sorted = [..._coverageData].sort((a, b) =>
                sort === 'trips' ? b.trips - a.trips : (a.name_en || '').localeCompare(b.name_en || ''));
            const top = sorted.slice(0, 16);
            const max = top[0]?.trips || 1;

            $('coverageChart').innerHTML = top.map((r, i) => `
    <div class="bar-row">
      <div class="bar-lbl" title="${r.name_en || r.country_code}">${r.name_en || r.country_code}</div>
      <div class="bar-bg">
        <div class="bar-fill" style="width:${Math.max(1, (r.trips / max * 100)).toFixed(1)}%;background:${PALETTE[i % PALETTE.length]}"></div>
      </div>
      <div class="bar-val">${fmt(r.trips)}</div>
    </div>`).join('');
        }

        // ================================================================
        //  ENVIRONMENTAL KPIs
        // ================================================================
        const ENV_TITLES = {
            co2_route: 'Average CO2 per route — train vs plane',
            co2_km: 'CO2 intensity per km by operator',
            day_night: 'Day vs Night — environmental comparison',
        };

        async function loadEnvKpi() {
            const kpi = gv('envKpiSelect');
            const cabin = gv('envCabin');
            const lim = parseInt(gv('envLimit')) || 20;
            $('envKpiTitle').textContent = ENV_TITLES[kpi];
            loading('envKpiBody');
            try {
                const trips = await api(`/trips?limit=${lim}`);
                const valid = trips.filter(t => t.departure_lat && t.arrival_lat);
                if (kpi === 'co2_route') renderCo2Route(valid, cabin);
                else if (kpi === 'co2_km') renderCo2Km(valid, cabin);
                else if (kpi === 'day_night') renderDayNight(valid, cabin);
            } catch (e) {
                $('envKpiBody').innerHTML = `<div class="state">Error: ${e.message}</div>`;
            }
        }

        function dist(t) { return haversine(+t.departure_lat, +t.departure_lon, +t.arrival_lat, +t.arrival_lon) * DETOUR; }

        function renderCo2Route(trips, cabin) {
            const rows = trips.map(t => {
                const d = dist(t), tG = Math.round(d * CO2_TRAIN), pG = Math.round(d * CO2_PLANE[cabin]);
                return { t, d: Math.round(d), tG, pG, sv: pG - tG, pc: Math.round(((pG - tG) / pG) * 100) };
            }).sort((a, b) => b.sv - a.sv).slice(0, 15);

            const avgT = Math.round(rows.reduce((s, r) => s + r.tG, 0) / rows.length);
            const avgP = Math.round(rows.reduce((s, r) => s + r.pG, 0) / rows.length);

            $('envKpiBody').innerHTML = `
    <div class="metric-pair" style="margin-bottom:16px">
      <div class="metric-box">
        <div class="metric-lbl">Avg train CO2 / route</div>
        <div class="metric-val" style="color:var(--green)">${fmt(avgT)} g</div>
      </div>
      <div class="metric-box">
        <div class="metric-lbl">Avg plane CO2 / route (${cabin})</div>
        <div class="metric-val" style="color:var(--red)">${fmt(avgP)} g</div>
      </div>
    </div>
    <div class="tbl-wrap">
    <table><thead><tr>
      <th>Route</th><th>Dist (km)</th>
      <th>Train CO2 (g)</th><th>Plane CO2 (g)</th><th>Saving</th>
    </tr></thead><tbody>
    ${rows.map(r => `<tr>
      <td style="font-weight:500;color:var(--text)">${r.t.departure_station || '?'} &rarr; ${r.t.arrival_station || '?'}</td>
      <td>${r.d}</td>
      <td style="color:var(--green);font-weight:600">${fmt(r.tG)}</td>
      <td style="color:var(--red);font-weight:600">${fmt(r.pG)}</td>
      <td>${badge('-' + fmt(r.sv) + ' g (' + r.pc + '%)', 'green')}</td>
    </tr>`).join('')}
    </tbody></table></div>
    <div class="source-note">Sources: EEA / ADEME. Train: ${CO2_TRAIN} g CO2/km/pax (EU electric average).
    Plane: economy 89 g / business 198 g / first 290 g — radiative forcing x1.9 included.</div>`;
        }

        function renderCo2Km(trips, cabin) {
            const byOp = {};
            trips.forEach(t => {
                const op = t.operator || 'Unknown', d = dist(t);
                if (!byOp[op]) byOp[op] = { tT: 0, dist: 0 };
                byOp[op].tT += Math.round(d * CO2_TRAIN); byOp[op].dist += d;
            });
            const rows = Object.entries(byOp)
                .map(([op, v]) => ({ op, gkm: (v.tT / v.dist).toFixed(1) }))
                .sort((a, b) => a.gkm - b.gkm);
            const max = Math.max(...rows.map(r => +r.gkm));

            $('envKpiBody').innerHTML = `
    <div class="bars">${rows.map((r, i) => `
      <div class="bar-row">
        <div class="bar-lbl">${r.op}</div>
        <div class="bar-bg"><div class="bar-fill" style="width:${(+r.gkm / max * 100).toFixed(1)}%;background:${PALETTE[i % PALETTE.length]}"></div></div>
        <div class="bar-val">${r.gkm} g/km</div>
      </div>`).join('')}
    </div>
    <div class="source-note">Plane reference (${cabin}): ${CO2_PLANE[cabin]} g/km/pax.</div>`;
        }

        function renderDayNight(trips, cabin) {
            const day = trips.filter(t => !t.is_night), night = trips.filter(t => t.is_night);
            function avg(arr) {
                if (!arr.length) return { tG: 0, pG: 0, d: 0 };
                const s = arr.reduce((a, t) => { const d = dist(t); return { tG: a.tG + Math.round(d * CO2_TRAIN), pG: a.pG + Math.round(d * CO2_PLANE[cabin]), d: a.d + d }; }, { tG: 0, pG: 0, d: 0 });
                return { tG: Math.round(s.tG / arr.length), pG: Math.round(s.pG / arr.length), d: Math.round(s.d / arr.length) };
            }
            const dA = avg(day), nA = avg(night);
            $('envKpiBody').innerHTML = `
    <div class="metric-pair">
      <div class="metric-box">
        <div class="metric-lbl">Day trains — avg CO2 / trip</div>
        <div class="metric-val" style="color:var(--accent)">${fmt(dA.tG)} g</div>
        <div class="metric-sub">Avg distance ${fmt(dA.d)} km &middot; ${day.length} trips</div>
        <div class="metric-sub" style="color:var(--red);margin-top:8px">Plane equiv: ${fmt(dA.pG)} g</div>
      </div>
      <div class="metric-box">
        <div class="metric-lbl">Night trains — avg CO2 / trip</div>
        <div class="metric-val" style="color:var(--purple)">${fmt(nA.tG)} g</div>
        <div class="metric-sub">Avg distance ${fmt(nA.d)} km &middot; ${night.length} trips</div>
        <div class="metric-sub" style="color:var(--red);margin-top:8px">Plane equiv: ${fmt(nA.pG)} g</div>
      </div>
    </div>
    <div class="saving-box">
      Night trains replace flights on longer distances, saving on average
      <strong>${fmt(nA.pG - nA.tG)} g CO2</strong> per trip compared to flying (${cabin} class).
    </div>`;
        }

        // ================================================================
        //  DEMAND & BUSINESS KPIs
        // ================================================================
        const DEMAND_TITLES = {
            operator_share: 'Operator market share — trip volume',
            cross_border: 'Cross-border vs domestic traffic',
            night_share: 'Night train share by country',
        };

        async function loadDemandKpi() {
            const kpi = gv('demandKpiSelect');
            $('demandTitle').textContent = DEMAND_TITLES[kpi];
            loading('demandBody');
            try {
                if (kpi === 'operator_share') {
                    const [trips, ops] = await Promise.all([api('/trips?limit=5000'), api('/operators')]);
                    renderOpShare(trips, ops);
                } else if (kpi === 'cross_border') {
                    renderCrossBorder(await api('/stats/coverage'));
                } else {
                    const [trips, cov] = await Promise.all([api('/trips?limit=5000'), api('/coverage')]);
                    renderNightShare(trips, cov);
                }
            } catch (e) {
                $('demandBody').innerHTML = `<div class="state">Error: ${e.message}</div>`;
            }
        }

        function renderOpShare(trips, ops) {
            const cnt = {};
            trips.forEach(t => { const o = t.operator || '?'; cnt[o] = (cnt[o] || 0) + 1; });
            const total = trips.length || 1;
            const rows = Object.entries(cnt).sort((a, b) => b[1] - a[1]).slice(0, 12);
            const max = rows[0]?.[1] || 1;
            const opMap = Object.fromEntries(ops.map(o => [o.operator_id, o.operator_name]));

            $('demandBody').innerHTML = `<div class="bars">${rows.map(([op, n], i) => `
    <div class="bar-row">
      <div class="bar-lbl" title="${opMap[op] || op}">${opMap[op] || op}</div>
      <div class="bar-bg"><div class="bar-fill"
        style="width:${(n / max * 100).toFixed(1)}%;background:${PALETTE[i % PALETTE.length]}"></div></div>
      <div class="bar-val">${fmt(n)} <span style="color:var(--muted);font-size:10px">(${(n / total * 100).toFixed(1)}%)</span></div>
    </div>`).join('')}
  </div>`;
        }

        function renderCrossBorder(stats) {
            const total = stats.total_trips || 1, cross = stats.cross_border_trips || 0, dom = total - cross;
            const cp = (cross / total * 100).toFixed(1), dp = (dom / total * 100).toFixed(1);
            $('demandBody').innerHTML = `
    <div class="metric-pair" style="max-width:480px;margin-bottom:16px">
      <div class="metric-box">
        <div class="metric-lbl">Cross-border</div>
        <div class="metric-val" style="color:var(--amber)">${fmt(cross)}</div>
        <div class="metric-sub">${cp}% of total trips</div>
      </div>
      <div class="metric-box">
        <div class="metric-lbl">Domestic</div>
        <div class="metric-val" style="color:var(--accent)">${fmt(dom)}</div>
        <div class="metric-sub">${dp}% of total trips</div>
      </div>
    </div>
    <div class="bars" style="max-width:480px">
      <div class="bar-row">
        <div class="bar-lbl">Cross-border</div>
        <div class="bar-bg"><div class="bar-fill" style="width:${cp}%;background:var(--amber)"></div></div>
        <div class="bar-val">${cp}%</div>
      </div>
      <div class="bar-row">
        <div class="bar-lbl">Domestic</div>
        <div class="bar-bg"><div class="bar-fill" style="width:${dp}%;background:var(--accent)"></div></div>
        <div class="bar-val">${dp}%</div>
      </div>
    </div>`;
        }

        function renderNightShare(trips, cov) {
            const byC = {};
            trips.forEach(t => { const c = t.country || '?'; if (!byC[c]) byC[c] = { t: 0, n: 0 }; byC[c].t++; if (t.is_night) byC[c].n++; });
            const covMap = Object.fromEntries(cov.map(c => [c.country_code, c.name_en || c.name_fr || c.country_code]));
            const rows = Object.entries(byC)
                .map(([c, v]) => ({ c, name: covMap[c] || c, pct: (v.n / v.t * 100).toFixed(1) }))
                .sort((a, b) => b.pct - a.pct);
            const max = rows[0]?.pct || 1;
            $('demandBody').innerHTML = `<div class="bars">${rows.map((r, i) => `
    <div class="bar-row">
      <div class="bar-lbl">${r.name}</div>
      <div class="bar-bg"><div class="bar-fill"
        style="width:${(+r.pct / +max * 100).toFixed(1)}%;background:${PALETTE[i % PALETTE.length]}"></div></div>
      <div class="bar-val">${r.pct}%</div>
    </div>`).join('')}
  </div>`;
        }

        // ================================================================
        //  COVERAGE FULL
        // ================================================================
        async function loadCoverageFull() {
            if ($('coverageFullBody').dataset.loaded) return;
            loading('coverageFullBody');
            try {
                const data = await api('/coverage');
                const total = data.reduce((s, r) => s + r.trips, 0) || 1;
                $('coverageFullBody').innerHTML = `<table>
      <thead><tr><th>Country</th><th>ISO3</th><th>Trips</th><th>Share</th></tr></thead>
      <tbody>${data.map(r => `<tr>
        <td style="font-weight:500;color:var(--text)">${r.name_en || r.name_fr || r.country_code}</td>
        <td>${badge(r.iso3_code || r.country_code, 'blue')}</td>
        <td style="font-weight:600">${fmt(r.trips)}</td>
        <td>
          <div style="display:flex;align-items:center;gap:8px">
            <div class="bar-bg" style="width:100px"><div class="bar-fill"
              style="width:${(r.trips / total * 100).toFixed(1)}%;background:var(--accent)"></div></div>
            <span style="font-size:11px;color:var(--muted)">${(r.trips / total * 100).toFixed(1)}%</span>
          </div>
        </td>
      </tr>`).join('')}
      </tbody></table>`;
                $('coverageFullBody').dataset.loaded = '1';
            } catch (e) { $('coverageFullBody').innerHTML = `<div class="state">Failed: ${e.message}</div>`; }
        }

        // ================================================================
        //  OPERATORS
        // ================================================================
        async function loadOperators() {
            if ($('operatorsTable').dataset.loaded) return;
            loading('operatorsTable');
            try {
                const data = await api('/operators');
                $('operatorsTable').innerHTML = `<table>
      <thead><tr><th>ID</th><th>Name</th><th>Country</th><th>Type</th></tr></thead>
      <tbody>${data.map(o => `<tr>
        <td style="font-family:monospace;font-size:11px;color:var(--accent)">${o.operator_id}</td>
        <td style="font-weight:500;color:var(--text)">${o.operator_name || '–'}</td>
        <td>${o.operator_country || '–'}</td>
        <td>${o.is_night_operator ? badge('Night', 'purple') : badge('Day', 'blue')}</td>
      </tr>`).join('')}
      </tbody></table>`;
                $('operatorsTable').dataset.loaded = '1';
            } catch (e) { $('operatorsTable').innerHTML = `<div class="state">Failed: ${e.message}</div>`; }
        }

        // ================================================================
        //  TRIP EXPLORER
        // ================================================================
        let map, routeLayer, _mapReady = false;

        function initMapOnce() {
            if (_mapReady) return;
            map = L.map('map').setView([48.5, 10], 5);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                { maxZoom: 18, attribution: '&copy; OpenStreetMap contributors' }).addTo(map);
            routeLayer = L.layerGroup().addTo(map);
            _mapReady = true;
        }

        async function loadCountries() {
            try {
                const data = await api('/countries');
                const sel = $('expCountry');
                data.forEach(r => {
                    const o = document.createElement('option');
                    o.value = r.country_code;
                    o.textContent = `${r.country_code} – ${r.name_en || r.name_fr || ''}`;
                    sel.appendChild(o);
                });
            } catch (e) { }
        }

        async function loadTrips() {
            initMapOnce();
            const p = new URLSearchParams();
            const v = id => $(id).value.trim();
            if (v('expCountry')) p.append('country_code', v('expCountry'));
            if (v('expOperator')) p.append('operator_id', v('expOperator'));
            if (v('expDep')) p.append('departure_station', v('expDep'));
            if (v('expArr')) p.append('arrival_station', v('expArr'));
            if (v('expNight')) p.append('is_night', v('expNight'));
            p.append('limit', v('expLimit') || 50);

            $('tripTable').innerHTML = `<div class="state"><span class="spinner"></span>Searching</div>`;
            routeLayer.clearLayers();

            try {
                const data = await api('/trips?' + p);
                const co2 = v('expCo2Mode') === 'column';
                const cabin = v('expCabin');
                $('tripCount').textContent = `${data.length} result${data.length !== 1 ? 's' : ''}`;

                if (!data.length) {
                    $('tripTable').innerHTML = '<div class="state">No results found. Adjust your filters.</div>';
                    return;
                }

                const th = co2
                    ? '<th>ID</th><th>Country</th><th>Operator</th><th>Type</th><th>Departure</th><th>Arrival</th><th>Dist (km)</th><th>Train CO2 (g)</th><th>Plane CO2 (g)</th><th>Saving</th><th>Stops</th>'
                    : '<th>ID</th><th>Country</th><th>Operator</th><th>Type</th><th>Date</th><th>Time</th><th>Departure</th><th>Arrival</th><th>Stops</th>';

                let bounds = [];
                const trs = data.map(row => {
                    const typeBadge = row.is_night ? badge('Night', 'purple') : badge('Day', 'blue');
                    const stopBtn = `<button class="btn btn-ghost" style="padding:3px 8px;font-size:11px"
        onclick="loadStops('${row.trip_id}','${row.operator}','${row.country}')">View</button>`;
                    let d = null, tG = null, pG = null;
                    if (row.departure_lat && row.arrival_lat) {
                        d = haversine(+row.departure_lat, +row.departure_lon, +row.arrival_lat, +row.arrival_lon) * DETOUR;
                        tG = Math.round(d * CO2_TRAIN); pG = Math.round(d * CO2_PLANE[cabin]);
                        L.polyline([[+row.departure_lat, +row.departure_lon], [+row.arrival_lat, +row.arrival_lon]],
                            { color: '#4f7ef7', weight: 1.8, opacity: .55 }).addTo(routeLayer);
                        bounds.push([+row.departure_lat, +row.departure_lon], [+row.arrival_lat, +row.arrival_lon]);
                    }
                    if (co2) {
                        const sv = tG != null ? pG - tG : null;
                        const pc = sv != null ? Math.round(sv / pG * 100) : null;
                        const sB = sv != null ? (sv > 0 ? badge('-' + fmt(sv) + ' g (' + pc + '%)', 'green') : badge('+' + fmt(Math.abs(sv)) + ' g', 'red')) : '–';
                        return `<tr><td>${row.fact_trip_key}</td><td>${row.country || ''}</td><td>${row.operator || ''}</td>
          <td>${typeBadge}</td><td>${row.departure_station || ''}</td><td>${row.arrival_station || ''}</td>
          <td>${d ? Math.round(d) : '–'}</td>
          <td style="color:var(--green);font-weight:600">${tG ?? '–'}</td>
          <td style="color:var(--red);font-weight:600">${pG ?? '–'}</td>
          <td>${sB}</td><td>${stopBtn}</td></tr>`;
                    } else {
                        return `<tr><td>${row.fact_trip_key}</td><td>${row.country || ''}</td><td>${row.operator || ''}</td>
          <td>${typeBadge}</td><td>${row.departure_date || ''}</td><td>${row.departure_time || ''}</td>
          <td style="font-weight:500;color:var(--text)">${row.departure_station || ''}</td>
          <td style="font-weight:500;color:var(--text)">${row.arrival_station || ''}</td>
          <td>${stopBtn}</td></tr>`;
                    }
                });

                $('tripTable').innerHTML = `<table><thead><tr>${th}</tr></thead><tbody>${trs.join('')}</tbody></table>`;
                if (bounds.length) map.fitBounds(bounds, { padding: [20, 20] });
            } catch (e) {
                $('tripTable').innerHTML = `<div class="state">Error: ${e.message}</div>`;
            }
        }

        async function loadStops(tripId, opId, cc) {
            try {
                const p = new URLSearchParams({ trip_id: tripId, operator_id: opId, country_code: cc });
                const data = await api('/trip_stops?' + p);
                $('stopsList').innerHTML = data.length
                    ? data.map(s => `<div class="stop-row">
          <span class="stop-seq">${s.stop_sequence}</span>
          <span class="stop-name">${s.stop_name || s.stop_id}</span>
          <span class="stop-meta">${s.stop_lat}, ${s.stop_lon} &middot; arr ${s.arrival_time || '–'} dep ${s.departure_time || '–'}</span>
        </div>`).join('')
                    : '<div class="state">No stops found.</div>';
                $('stopsCard').style.display = 'block';
                $('stopsCard').scrollIntoView({ behavior: 'smooth' });
            } catch (e) { alert('Could not load stops: ' + e.message); }
        }

        // ================================================================
        //  INIT
        // ================================================================
        loadCountries();
        loadOverview();
    </script>
</body>

</html>
